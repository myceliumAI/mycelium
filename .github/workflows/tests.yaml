name: Test Workflow

permissions:
  contents: read
  pull-requests: read

on:
  workflow_call:
    inputs:
      matrix:
        required: true
        type: string
        description: 'JSON array of services to test'
    outputs:
      coverage_reports:
        description: "JSON object containing coverage reports"
        value: ${{ jobs.test.outputs.coverage_reports }}
    secrets:
      CODECOV_TOKEN:
        required: false

jobs:
  test:
    permissions:
      contents: read
      checks: write
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        service: ${{ fromJson(inputs.matrix) }}
        include:
          - service: frontend
            path: ./mycelium
            type: node
            test_command: yarn test
          - service: api
            path: ./backend/api
            type: python
            test_command: poetry run pytest
          - service: auth
            path: ./backend/keycloak
            type: java
            test_command: ./mvnw test
      fail-fast: false
    
    outputs:
      coverage_reports: ${{ steps.coverage.outputs.reports }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4.1.1  # DÃ©jÃ  Ã  jour
        with:
          fetch-depth: 0

      - name: Load Test Configuration
        uses: ./.github/actions/shared/load-config
        with:
          test_type: unit

      - name: Setup Environment
        uses: ./.github/actions/shared/setup
        with:
          service-type: ${{ matrix.type }}
          
      - name: Cache Test Dependencies
        uses: actions/cache@13aacd865c20de90d75de3b17ebe84f7a17d57d2  # v4.0.0
        with:
          path: |
            ~/.cache/pip
            ~/.cache/poetry
            **/node_modules
            ~/.m2/repository
          key: ${{ runner.os }}-test-${{ matrix.service }}-${{ hashFiles('**/poetry.lock', '**/yarn.lock', '**/pom.xml') }}

      - name: Run Unit Tests
        id: unit
        shell: bash
        run: |
          case "${{ matrix.type }}" in
            "node")
              echo "ðŸ§ª Running Node.js unit tests"
              yarn test --coverage
              ;;
            "python")
              echo "ðŸ§ª Running Python unit tests"
              poetry run pytest --cov --cov-report=xml
              ;;
            "java")
              echo "ðŸ§ª Running Java unit tests"
              ./mvnw test jacoco:report
              ;;
            *)
              echo "âŒ Unknown service type: ${{ matrix.type }}"
              exit 1
              ;;
          esac
        working-directory: ${{ matrix.path }}
        env:
          NODE_ENV: test
          PYTHON_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379/0

      - name: Run Integration Tests
        id: integration
        if: success() && matrix.type != 'frontend'
        shell: bash
        run: |
          case "${{ matrix.type }}" in
            "python")
              echo "ðŸ§ª Running Python integration tests"
              poetry run pytest tests/integration --cov --cov-report=xml
              ;;
            "java")
              echo "ðŸ§ª Running Java integration tests"
              ./mvnw verify
              ;;
            *)
              echo "âš ï¸ Skipping integration tests for ${{ matrix.type }}"
              ;;
          esac
        working-directory: ${{ matrix.path }}

      - name: Process Coverage Reports
        id: coverage
        shell: bash
        run: |
          COVERAGE_FILE=""
          case "${{ matrix.type }}" in
            "node")
              COVERAGE_FILE="coverage/lcov.info"
              ;;
            "python")
              COVERAGE_FILE="coverage.xml"
              ;;
            "java")
              COVERAGE_FILE="target/site/jacoco/jacoco.xml"
              ;;
          esac
          
          if [ -f "${{ matrix.path }}/$COVERAGE_FILE" ]; then
            echo "reports=$(echo '{\"${{ matrix.service }}\": \"$COVERAGE_FILE\"}' | jq -c .)" >> $GITHUB_OUTPUT
          fi

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@c4cf8a4f03f0ac8585acb7c1b7ce3460ec15782f  # v4.1.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ matrix.path }}/${{ fromJson(steps.coverage.outputs.reports)[matrix.service] }}
          flags: ${{ matrix.service }}
          fail_ci_if_error: true